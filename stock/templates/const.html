{% extends 'store/base.html' %}
{% block content %}
    {% load staticfiles %}
    <script>
        var constants = null;
        $(document).ready(function () {
            //getProps("0");
            //pr = new Property($("#propData").prop("value"));
             constants = JSON.parse($("#const_data").prop("value"));
        });
        function confirmDel(name, obj) {
            $("#delBtn").unbind();
            $("#delBtn").click(function(){
                delConst(obj);
            });
            $("#del-name").text(name);
            $("#del_modal").modal();
        }
        function delConst(obj) {
            var csrftoken = getCookie('csrftoken');
            $.ajax({
                type: "POST",
                url: 'del_const/',
                data: {
                    'id': $(obj.parentElement).prop("id")
                },
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                },
                success: function onAjaxSuccess(data) {
                    $(obj.parentElement).remove();
                    $("#del_modal").modal('toggle');
                }
            });
        };
        function sendConst() {
            if ($('#form')[0].checkValidity()) {
                var csrftoken = getCookie('csrftoken');
                $.ajax({
                    type: "POST",
                    url: 'send_const/',
                    data: {
                        'name': $('#name').prop('value'),
                        'value': $('#value').prop('value')
                    },
                    beforeSend: function (xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                    },
                    success: function onAjaxSuccess(data) {
                        window.location.reload();
                    }
                });
            }
            else {
                $('<input type="submit">').hide().appendTo("#form").click().remove();
            }
        }
        function getConstInf(id) {
            $("#e_name").prop("value", constants[id].name);
            $("#e_value").prop("value", constants[id].value);

            $("#editBtn").unbind('click');
            $("#editBtn").click(function () {
                editConst(id);
            });
            $("#inf_const").modal();
        }
        function editConst(id) {
            if ($('#edit_form')[0].checkValidity()) {
                var csrftoken = getCookie('csrftoken');
                $.ajax({
                    type: "POST",
                    url: 'edit_const/',
                    data: {
                        'id': id,
                        'name': $('#e_name').prop('value'),
                        'value': $('#e_value').prop('value')
                    },
                    beforeSend: function (xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                    },
                    success: function onAjaxSuccess(data) {
                        window.location.reload();
                    }
                });
            }
            else {
                $('<input type="submit">').hide().appendTo("#edit_form").click().remove();
            }
        }
    </script>
    <div class="container-fluid">
    <input id="const_data" value="{{ const_data }}" hidden/>

                <div class="card" style="margin-left: 30px;margin-right: 30px;">
                    <div class="card-header">
                        <div class="filter">
                            <div class="form-inline">
                        <button type="button" class="btn btn-success btn-sm"  data-toggle="modal" data-target="#add_prop">Добавить константу</button>

                            </div>
                        </div>
                    </div>
                    <div class="goods_table">
                        <table class="table table-bordered table-sm">
                            <thead class="thead-light">
                            <tr>
                                <!--<th scope="col">Код</th>-->
                                <th scope="col">Наименование</th>
                                <th scope="col">Значение</th>
                                <th scope="col"></th>

                            </tr>
                            </thead>
                            <tbody id="goods-body">
                            {% for c in const %}
                                <tr id="{{ c.id }}">
                                    <td>{{ c.name }}</td>
                                    <td>{{ c.value }}</td>
                                    <td><span
                          onclick="getConstInf({{ c.id }})"><i class='fas fa-edit' title="Редактировать"></i></span><span onclick="confirmDel('{{ c.name }}', this.parentElement)"><i class='fas fa-trash-alt menu-btn' title="Удалить"></i></span></td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
        </div>
    </div>
    <div class="modal fade" id="add_prop">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Создание константы</h5>
                    <button class="close" data-dismiss="modal">x</button>

                </div>
                <div class="modal-body create-form">
                    <form id="form">
                    <h6>Наименование</h6>
                    <input type="text" class="form-control" id="name" required/>
                    <h6>Значение</h6>
                    <input type="number" class="form-control" id="value" required/>
                    </form>
                    <div class="modal-footer" style="margin-top:5pt">
                        <input value="Сохранить" id="packBtn" onclick="sendConst()" class="btn btn-primary"
                               style="float: right"/></div>
                </div>
            </div>
        </div>
    </div>

     <div class="modal fade" id="inf_const">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Редактирование константы</h5>
                    <button class="close" data-dismiss="modal">x</button>

                </div>
                <div class="modal-body create-form">
                    <form id="edit_form">
                        <h6>Наименование</h6>
                        <input type="text" class="form-control" id="e_name" required/>
                        <h6>Значение</h6>
                        <input type="number" class="form-control" step="0.0001" id="e_value" required/>
                    </form>
                    <div class="modal-footer" style="margin-top:5pt">
                        <input value="Сохранить" id="editBtn" class="btn btn-primary"
                               style="float: right"/></div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="del_modal">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Удаление константы</h5>
                    <button class="close" data-dismiss="modal">x</button>

                </div>
                <div class="modal-body create-form">
                    <h6>Удалить <span id="del-name"></span>?</h6>
                    <div class="modal-footer" style="margin-top:5pt">
                        <input value="Удалить" id="delBtn" onclick="" class="btn btn-primary"
                               style="float: right"/></div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
